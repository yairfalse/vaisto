{
  "system": "Vaisto LSP Server",
  "version": "0.1.0",
  "protocol": "JSON-RPC 2.0 (Language Server Protocol)",
  "test_cases": [
    {
      "id": "POS-001",
      "category": "Positive",
      "name": "Initialize handshake",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}}
      ],
      "expect_response_id": 1,
      "expect_result_keys": ["capabilities", "serverInfo"],
      "expect_capability": "hoverProvider"
    },
    {
      "id": "POS-002",
      "category": "Positive",
      "name": "Shutdown returns null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "shutdown", "id": 2, "params": null}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "POS-003",
      "category": "Positive",
      "name": "didOpen valid file → no diagnostics",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/test.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_count": 0
    },
    {
      "id": "POS-004",
      "category": "Positive",
      "name": "didOpen invalid file → error diagnostics",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/bad.va", "languageId": "vaisto", "version": 1, "text": "(defn broken [x :int] :string x)"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_min": 1
    },
    {
      "id": "POS-005",
      "category": "Positive",
      "name": "didOpen parse error → diagnostics",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/parse_err.va", "languageId": "vaisto", "version": 1, "text": "(defn oops [x"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_min": 1
    },
    {
      "id": "POS-006",
      "category": "Positive",
      "name": "didClose clears diagnostics",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/close.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))"}}},
        {"method": "textDocument/didClose", "params": {"textDocument": {"uri": "file:///tmp/close.va"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_count": 0,
      "expect_notification_uri": "file:///tmp/close.va"
    },
    {
      "id": "POS-007",
      "category": "Positive",
      "name": "Hover on function name → type info",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/hover.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))"}}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/hover.va"}, "position": {"line": 0, "character": 6}}}
      ],
      "expect_response_id": 2,
      "expect_result_not_null": true
    },
    {
      "id": "POS-008",
      "category": "Positive",
      "name": "DocumentSymbol returns function outline",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/sym.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))\n(defn double [x :int] :int (* x 2))"}}},
        {"method": "textDocument/documentSymbol", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/sym.va"}}}
      ],
      "expect_response_id": 2,
      "expect_result_is_list": true,
      "expect_result_min_length": 2
    },
    {
      "id": "POS-009",
      "category": "Positive",
      "name": "Completion at function call position",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/comp.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))\n(a"}}},
        {"method": "textDocument/completion", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/comp.va"}, "position": {"line": 1, "character": 2}}}
      ],
      "expect_response_id": 2,
      "expect_result_not_null": true
    },
    {
      "id": "POS-010",
      "category": "Positive",
      "name": "didChange updates diagnostics",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/change.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))"}}},
        {"method": "textDocument/didChange", "params": {"textDocument": {"uri": "file:///tmp/change.va", "version": 2}, "contentChanges": [{"text": "(defn add [x :int y :int] :string (+ x y))"}]}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_min": 1
    },
    {
      "id": "POS-011",
      "category": "Positive",
      "name": "Definition on variable → location",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/def.va", "languageId": "vaisto", "version": 1, "text": "(defn double [x :int] :int (* x 2))"}}},
        {"method": "textDocument/definition", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/def.va"}, "position": {"line": 0, "character": 33}}}
      ],
      "expect_response_id": 2
    },
    {
      "id": "POS-012",
      "category": "Positive",
      "name": "SignatureHelp inside function call",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/sig.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))\n(add "}}},
        {"method": "textDocument/signatureHelp", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/sig.va"}, "position": {"line": 1, "character": 5}}}
      ],
      "expect_response_id": 2
    },
    {
      "id": "POS-013",
      "category": "Positive",
      "name": "References finds all usages",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/ref.va", "languageId": "vaisto", "version": 1, "text": "(defn double [x :int] :int (* x 2))\n(defn quad [x :int] :int (double (double x)))"}}},
        {"method": "textDocument/references", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/ref.va"}, "position": {"line": 0, "character": 6}}}
      ],
      "expect_response_id": 2,
      "expect_result_is_list": true
    },
    {
      "id": "POS-014",
      "category": "Positive",
      "name": "PrepareRename on function name",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/ren.va", "languageId": "vaisto", "version": 1, "text": "(defn double [x :int] :int (* x 2))"}}},
        {"method": "textDocument/prepareRename", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/ren.va"}, "position": {"line": 0, "character": 6}}}
      ],
      "expect_response_id": 2
    },
    {
      "id": "POS-015",
      "category": "Positive",
      "name": "Rename symbol across document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/ren2.va", "languageId": "vaisto", "version": 1, "text": "(defn double [x :int] :int (* x 2))\n(double 5)"}}},
        {"method": "textDocument/rename", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/ren2.va"}, "position": {"line": 0, "character": 6}, "newName": "twice"}}
      ],
      "expect_response_id": 2
    },
    {
      "id": "POS-016",
      "category": "Positive",
      "name": "Capabilities include all advertised features",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}}
      ],
      "expect_response_id": 1,
      "expect_capabilities": ["hoverProvider", "definitionProvider", "documentSymbolProvider", "completionProvider", "signatureHelpProvider", "referencesProvider", "renameProvider"]
    },
    {
      "id": "POS-017",
      "category": "Positive",
      "name": "Hover on unopened document → null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/nonexistent.va"}, "position": {"line": 0, "character": 0}}}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "POS-018",
      "category": "Positive",
      "name": "DocumentSymbol with deftype and process",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/mixed.va", "languageId": "vaisto", "version": 1, "text": "(deftype Point [x :int y :int])\n(defn origin [] :Point (Point 0 0))\n(process counter 0 :get state)"}}},
        {"method": "textDocument/documentSymbol", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/mixed.va"}}}
      ],
      "expect_response_id": 2,
      "expect_result_is_list": true,
      "expect_result_min_length": 3
    },

    {
      "id": "NEG-001",
      "category": "Negative",
      "name": "Unknown method with id → error response",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/bogus", "id": 2, "params": {}}
      ],
      "expect_response_id": 2,
      "expect_error_code": -32601
    },
    {
      "id": "NEG-002",
      "category": "Negative",
      "name": "Hover on whitespace → null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/ws.va", "languageId": "vaisto", "version": 1, "text": "   \n\n(defn add [x :int y :int] :int (+ x y))"}}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/ws.va"}, "position": {"line": 0, "character": 0}}}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "NEG-003",
      "category": "Negative",
      "name": "Definition on nothing → null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/nodef.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 2)"}}},
        {"method": "textDocument/definition", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/nodef.va"}, "position": {"line": 0, "character": 0}}}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "NEG-004",
      "category": "Negative",
      "name": "PrepareRename on parenthesis → null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/noname.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 2)"}}},
        {"method": "textDocument/prepareRename", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/noname.va"}, "position": {"line": 0, "character": 0}}}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "NEG-006",
      "category": "Negative",
      "name": "PrepareRename on number literal → null",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/numlit.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 2)"}}},
        {"method": "textDocument/prepareRename", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/numlit.va"}, "position": {"line": 0, "character": 3}}}
      ],
      "expect_response_id": 2,
      "expect_result": null
    },
    {
      "id": "NEG-005",
      "category": "Negative",
      "name": "Completion on unopened doc → empty",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/completion", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/ghost.va"}, "position": {"line": 0, "character": 0}}}
      ],
      "expect_response_id": 2,
      "expect_result_is_list": true,
      "expect_result_length": 0
    },

    {
      "id": "SYS-001",
      "category": "System",
      "name": "Full lifecycle: init → open → edit → close → shutdown",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/life.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))"}}},
        {"method": "textDocument/didChange", "params": {"textDocument": {"uri": "file:///tmp/life.va", "version": 2}, "contentChanges": [{"text": "(defn add [x :int y :int] :int (+ x y))\n(defn sub [x :int y :int] :int (- x y))"}]}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/life.va"}, "position": {"line": 0, "character": 6}}},
        {"method": "textDocument/didClose", "params": {"textDocument": {"uri": "file:///tmp/life.va"}}},
        {"method": "shutdown", "id": 3, "params": null}
      ],
      "expect_response_id": 3,
      "expect_result": null
    },
    {
      "id": "SYS-002",
      "category": "System",
      "name": "Multiple documents open simultaneously",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/a.va", "languageId": "vaisto", "version": 1, "text": "(defn f [x :int] :int (* x 2))"}}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/b.va", "languageId": "vaisto", "version": 1, "text": "(defn g [x :int] :int (+ x 1))"}}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/a.va"}, "position": {"line": 0, "character": 6}}},
        {"method": "textDocument/hover", "id": 3, "params": {"textDocument": {"uri": "file:///tmp/b.va"}, "position": {"line": 0, "character": 6}}}
      ],
      "expect_response_id": 3,
      "expect_result_not_null": true
    },
    {
      "id": "SYS-003",
      "category": "System",
      "name": "Diagnostics cleared after fixing error",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/fix.va", "languageId": "vaisto", "version": 1, "text": "(defn bad [x :int] :string x)"}}},
        {"method": "textDocument/didChange", "params": {"textDocument": {"uri": "file:///tmp/fix.va", "version": 2}, "contentChanges": [{"text": "(defn good [x :int] :int x)"}]}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_count": 0
    },
    {
      "id": "SYS-004",
      "category": "System",
      "name": "Initialized notification accepted silently",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}}
      ],
      "expect_response_id": 1,
      "expect_no_extra_responses": true
    },
    {
      "id": "SYS-005",
      "category": "System",
      "name": "Unknown notification silently ignored",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "$/cancelRequest", "params": {"id": 999}}
      ],
      "expect_response_id": 1,
      "expect_no_crash": true
    },

    {
      "id": "INT-001",
      "category": "Integration",
      "name": "Diagnostics contain source field 'vaisto'",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/src.va", "languageId": "vaisto", "version": 1, "text": "(defn bad [x :int] :string x)"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_min": 1,
      "expect_diagnostic_source": "vaisto"
    },
    {
      "id": "INT-002",
      "category": "Integration",
      "name": "Diagnostics have valid LSP range (0-indexed)",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/range.va", "languageId": "vaisto", "version": 1, "text": "(defn bad [x :int] :string x)"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_min": 1,
      "expect_valid_ranges": true
    },
    {
      "id": "INT-003",
      "category": "Integration",
      "name": "ADT match with type_pattern resolves cleanly",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/adt.va", "languageId": "vaisto", "version": 1, "text": "(deftype Maybe (Just v) (Nothing))\n(defn unwrap [m :Maybe] :int\n  (match m\n    [(Just v) v]\n    [(Nothing) 0]))"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_count": 0
    },
    {
      "id": "INT-004",
      "category": "Integration",
      "name": "Simple ADT definition compiles clean",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/adt2.va", "languageId": "vaisto", "version": 1, "text": "(deftype Color (Red) (Green) (Blue))"}}}
      ],
      "expect_notification": "textDocument/publishDiagnostics",
      "expect_diagnostics_count": 0
    },

    {
      "id": "LOAD-001",
      "category": "Load",
      "name": "20 rapid didChange events",
      "messages_generate": {
        "prefix": [
          {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
          {"method": "initialized", "params": {}},
          {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/rapid.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 1)"}}}
        ],
        "repeat": 20,
        "template": {"method": "textDocument/didChange", "params": {"textDocument": {"uri": "file:///tmp/rapid.va", "version": "INDEX"}, "contentChanges": [{"text": "(+ 1 INDEX)"}]}}
      },
      "expect_no_crash": true
    },
    {
      "id": "LOAD-002",
      "category": "Load",
      "name": "10 documents opened concurrently",
      "messages_generate": {
        "prefix": [
          {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
          {"method": "initialized", "params": {}}
        ],
        "repeat": 10,
        "template": {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/doc_INDEX.va", "languageId": "vaisto", "version": 1, "text": "(defn f_INDEX [x :int] :int (+ x INDEX))"}}}
      },
      "expect_no_crash": true
    },

    {
      "id": "PERF-001",
      "category": "Performance",
      "name": "Initialize response under 500ms",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}}
      ],
      "expect_response_id": 1,
      "max_response_ms": 500
    },
    {
      "id": "PERF-002",
      "category": "Performance",
      "name": "Hover response under 1000ms",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/perf.va", "languageId": "vaisto", "version": 1, "text": "(defn add [x :int y :int] :int (+ x y))\n(defn double [x :int] :int (* x 2))\n(defn quad [x :int] :int (double (double x)))"}}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/perf.va"}, "position": {"line": 0, "character": 6}}}
      ],
      "expect_response_id": 2,
      "max_response_ms": 1000
    },

    {
      "id": "ABN-001",
      "category": "Abnormal",
      "name": "Empty document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/empty.va", "languageId": "vaisto", "version": 1, "text": ""}}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-002",
      "category": "Abnormal",
      "name": "Huge single-line document (10KB)",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/huge.va", "languageId": "vaisto", "version": 1, "text": "GENERATE_REPEATED:(+ 1 1) :2000"}}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-003",
      "category": "Abnormal",
      "name": "Unicode in source code",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/unicode.va", "languageId": "vaisto", "version": 1, "text": "; 日本語コメント\n(defn add [x :int y :int] :int (+ x y))"}}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-004",
      "category": "Abnormal",
      "name": "Hover at position beyond document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/oob.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 2)"}}},
        {"method": "textDocument/hover", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/oob.va"}, "position": {"line": 999, "character": 999}}}
      ],
      "expect_response_id": 2,
      "expect_no_crash": true
    },
    {
      "id": "ABN-005",
      "category": "Abnormal",
      "name": "Deeply nested expression",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/deep.va", "languageId": "vaisto", "version": 1, "text": "(+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 0)))))))))))))))))))"}}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-006",
      "category": "Abnormal",
      "name": "Binary content in document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didOpen", "params": {"textDocument": {"uri": "file:///tmp/bin.va", "languageId": "vaisto", "version": 1, "text": "\u0000\u0001\u0002\u0003"}}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-007",
      "category": "Abnormal",
      "name": "didChange before didOpen",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didChange", "params": {"textDocument": {"uri": "file:///tmp/never_opened.va", "version": 2}, "contentChanges": [{"text": "(+ 1 2)"}]}}
      ],
      "expect_no_crash": true
    },
    {
      "id": "ABN-008",
      "category": "Abnormal",
      "name": "Rename on unopened document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/rename", "id": 2, "params": {"textDocument": {"uri": "file:///tmp/no_such.va"}, "position": {"line": 0, "character": 0}, "newName": "x"}}
      ],
      "expect_response_id": 2,
      "expect_no_crash": true
    },
    {
      "id": "ABN-009",
      "category": "Abnormal",
      "name": "Save of unopened document",
      "messages": [
        {"method": "initialize", "id": 1, "params": {"processId": null, "rootUri": "file:///tmp/lsp_test", "capabilities": {}}},
        {"method": "initialized", "params": {}},
        {"method": "textDocument/didSave", "params": {"textDocument": {"uri": "file:///tmp/unsaved.va"}}}
      ],
      "expect_no_crash": true
    }
  ]
}
